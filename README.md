## Description

This repository is an example of a simple web application with a API rate limiter based on the [sliding window](https://en.wikipedia.org/wiki/Sliding_window_protocol) strategy, using a Redis cache instead of the Nest.js default throttle guard.

It uses a middleware to intercept the request and check if the user has exceeded the limit of requests. If so, it returns a 429 TOO MANY REQUESTS status code with an error message with the seconds left until the limiting is lifted.

The rate limit is based on the user IP address for public routes and a API token for private routes.

There are  2 sets of routes:

- Public routes: `/public/a`, `/public/b`, `/public/c`. These routes do not require authentication and measure rate limit per ip address.
  
- Private routes: `/private/a`, `/private/b`, `/private/c`. These routes require authentication via API Key in request header and measure rate limit per API Key.

Each route has a different weight to calculate the rate limit. These weights are defined in the `public.routes.ts` and `private.routes.ts` files inside each module.

The limits for both public and private routes are defined in the `.env` file, and are set to 100 and 200 requests per hour, respectively.

Weights are stored in a Redis key with the following format: `rate-limit:{token}:{uuid}`, where `token` is the API token or the IP address and `uuid` is an autogenerated UUID.

There is an API Key authentication guard for the private routes that checks if the API token is valid. The API Key should be passed in the `x-api-key` header.

The app uses a mocked database to check if the API token is among the registered ones. Any of the following tokens is valid in the mocked database:

```
  '026a2f78-d68c-4e9e-8c9c-ad53f1c74cec'
  '3dc36e31-0ef7-4fde-9894-1b93ce59e6a3'
  '030743e0-bd92-4baa-801a-282710b5648b'
  '95a80b45-87ab-457f-84e1-e4805e020b1c'
  '974a0506-0d03-40b4-b030-08e30b99130f'
```

## Installation

```bash
# install dependencies
$ npm install

# initialize redis server
$ docker-compose up -d

# running e2e tests
$ npm run test:e2e

# running the app
$ npm run start
```
